<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ê´€ë¦¬ì í˜ì´ì§€ - mzí€´ì¦ˆ</title>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 2rem; background: #f8f8f8; }
    h2 { margin-top: 2rem; }
    input, textarea, select, button { margin: 0.3rem 0; padding: 0.4rem; width: 100%; max-width: 600px; }
    .section { margin-bottom: 3rem; background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 0 5px rgba(0,0,0,0.1); }
  </style>
</head>
<body>
  <h1>mzí€´ì¦ˆ ê´€ë¦¬ì í˜ì´ì§€</h1>

  <div id="auth">
    <p>ğŸ”’ ë¡œê·¸ì¸ í•„ìš”</p>
    <button id="loginBtn">êµ¬ê¸€ ë¡œê·¸ì¸</button>
  </div>

  <div id="adminPanel" style="display:none;">
    <div class="section">
      <h2>1ï¸âƒ£ í€´ì¦ˆ ë“±ë¡ (í€´ì¦ˆ í’€)</h2>
      <input type="text" id="regKeyword" placeholder="ì‹ ì¡°ì–´ ë‹¨ì–´" />
      <input type="text" id="regHint" placeholder="ììŒ íŒíŠ¸" />
      <textarea id="regMeaning" placeholder="ì˜ë¯¸ ì„¤ëª…"></textarea>
      <button id="regQuizBtn">ë“±ë¡í•˜ê¸°</button>
    </div>

    <div class="section">
      <h2>2ï¸âƒ£ í€´ì¦ˆ ë‚ ì§œ ë°°ì¹˜</h2>
      <select id="quizPool"></select>
      <input type="date" id="targetDate" />
      <button id="assignBtn">ì„ íƒí•œ í€´ì¦ˆë¥¼ í•´ë‹¹ ë‚ ì§œì— ë°°ì¹˜</button>
    </div>

    <div class="section">
      <h2>ğŸ“¥ ì œë³´ ëª©ë¡</h2>
      <ul id="suggestList"></ul>
    </div>
  </div>

  <script type="module">
    import {
      signIn,
      onAuthStateChangedHandler
    } from "./firebase.js";
    import { getDatabase, ref, push, get, set } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";

    const authUI = document.getElementById('auth');
    const panel = document.getElementById('adminPanel');

    function log(title, data) {
      console.log(`ğŸ› ï¸ ${title}`, data);
    }

    onAuthStateChangedHandler((user) => {
      if (user && user.email === "hale7292@gmail.com") {
        authUI.style.display = 'none';
        panel.style.display = 'block';
        loadQuizPool();
        loadSuggestions();
      } else {
        authUI.innerHTML = "<p>ğŸš« ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.</p>";
        panel.style.display = 'none';
      }
    });

    document.getElementById('loginBtn').addEventListener('click', () => {
      signIn((user) => {
        alert(`í™˜ì˜í•©ë‹ˆë‹¤, ${user.displayName}`);
      });
    });

    const db = getDatabase();

    // í€´ì¦ˆ ë“±ë¡ ì‹œ ì¤‘ë³µ ê²€ì‚¬ í¬í•¨
    document.getElementById('regQuizBtn').addEventListener('click', async () => {
      log('ğŸ“© [ë“±ë¡ ë²„íŠ¼ í´ë¦­ë¨]', '');

      const keyword = document.getElementById('regKeyword').value.trim();
      const hint = document.getElementById('regHint').value.trim();
      const meaning = document.getElementById('regMeaning').value.trim();

      log('ì…ë ¥ê°’ ê²€ì‚¬', { keyword, hint, meaning });

      if (!keyword || !hint || !meaning) {
        alert('ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
        return;
      }

      try {
        const poolSnap = await get(ref(db, 'quizzesPool'));
        const poolData = poolSnap.val() || {};
        const keywords = Object.values(poolData).map(q => q.keyword);

        if (keywords.includes(keyword)) {
          alert(`ì´ë¯¸ ë“±ë¡ëœ ë‹¨ì–´ì…ë‹ˆë‹¤: "${keyword}"`);
          return;
        }

        await push(ref(db, 'quizzesPool'), { keyword, hint, meaning });
        alert('í€´ì¦ˆê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
        log('âœ… í€´ì¦ˆ ë“±ë¡ ì„±ê³µ', { keyword, hint });
        document.getElementById('regKeyword').value = '';
        document.getElementById('regHint').value = '';
        document.getElementById('regMeaning').value = '';
        loadQuizPool();
      } catch (error) {
        console.error('âŒ [ì˜¤ë¥˜] í€´ì¦ˆ ë“±ë¡ ì‹¤íŒ¨:', error);
        alert('í€´ì¦ˆ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    });

    // í€´ì¦ˆ í’€ ë¶ˆëŸ¬ì˜¤ê¸° (ë°°ì¹˜ëœ ê²ƒ ì œì™¸)
    async function loadQuizPool() {
      try {
        const [poolSnap, assignedSnap] = await Promise.all([
          get(ref(db, 'quizzesPool')),
          get(ref(db, 'quizzes'))
        ]);

        const select = document.getElementById('quizPool');
        select.innerHTML = '';

        const poolData = poolSnap.val() || {};
        const assignedData = assignedSnap.val() || {};

        const assignedKeywords = Object.values(assignedData).map(q => q.keyword);

        Object.entries(poolData).forEach(([id, q]) => {
          if (assignedKeywords.includes(q.keyword)) return;
          const opt = document.createElement('option');
          opt.value = JSON.stringify(q);
          opt.textContent = `${q.keyword} / ${q.hint}`;
          select.appendChild(opt);
        });

        log('ğŸ“š ì„ íƒ ê°€ëŠ¥ í€´ì¦ˆ í’€ ë¡œë”© (ë°°ì¹˜ëœ ê²ƒ ì œì™¸)', poolData);
      } catch (error) {
        console.error('âŒ [ì˜¤ë¥˜] í€´ì¦ˆ í’€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', error);
      }
    }

    // ë‚ ì§œ ë°°ì¹˜
    document.getElementById('assignBtn').addEventListener('click', async () => {
      const raw = document.getElementById('quizPool').value;
      const date = document.getElementById('targetDate').value;
      if (!raw || !date) return alert('í€´ì¦ˆì™€ ë‚ ì§œë¥¼ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”');
      const quiz = JSON.parse(raw);
      await set(ref(db, `quizzes/${date}`), quiz);
      alert(`âœ… ${date}ì— í€´ì¦ˆê°€ ë°°ì¹˜ë˜ì—ˆìŠµë‹ˆë‹¤.`);
      loadQuizPool();
    });

    // ì œë³´ ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadSuggestions() {
      const ul = document.getElementById('suggestList');
      const snapshot = await get(ref(db, 'suggestions'));
      const data = snapshot.val() || {};
      ul.innerHTML = '';
      Object.values(data).reverse().forEach(entry => {
        const li = document.createElement('li');
        li.textContent = `${entry.term} - ${entry.meaning}`;
        ul.appendChild(li);
      });
    }
  </script>
</body>
</html>

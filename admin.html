<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>관리자 페이지 - mz퀴즈</title>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 2rem; background: #f8f8f8; }
    h2 { margin-top: 2rem; }
    input, textarea, select, button {
      margin: 0.3rem 0; padding: 0.4rem;
      width: 100%; max-width: 600px;
    }
    .section {
      margin-bottom: 3rem;
      background: white; padding: 1rem;
      border-radius: 8px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
  <h1>mz퀴즈 관리자 페이지</h1>

  <div id="auth">
    <p id="authMessage">🔒 로그인 필요</p>
    <button id="loginBtn">구글 로그인</button>
  </div>

  <div id="adminPanel" style="display:none;">
    <div class="section">
      <h2>1️⃣ 퀴즈 등록 (퀴즈 풀)</h2>
      <input type="text" id="regKeyword" placeholder="신조어 단어" />
      <input type="text" id="regHint" placeholder="자음 힌트" />
      <textarea id="regMeaning" placeholder="의미 설명"></textarea>
      <button id="regQuizBtn">등록하기</button>
    </div>

    <div class="section">
      <h2>2️⃣ 퀴즈 날짜 배치</h2>
      <select id="quizPool"></select>
      <input type="date" id="targetDate" />
      <button id="assignBtn">선택한 퀴즈를 해당 날짜에 배치</button>
    </div>

    <div class="section">
      <h2>📥 제보 목록</h2>
      <ul id="suggestList"></ul>
    </div>
  </div>

  <script type="module">
    import {
      signIn,
      onAuthStateChangedHandler,
      getCurrentUser,
      isAuthorized
    } from "./firebase.js";

    import {
      getDatabase,
      ref as dbRef,
      push as dbPush,
      get as dbGet,
      set as dbSet
    } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";

    const db = getDatabase();
    const authUI = document.getElementById('auth');
    const panel = document.getElementById('adminPanel');
    const authMessage = document.getElementById('authMessage');

    const log = (tag, value) => {
      console.log(`[%c${tag}%c]`, 'color: orange; font-weight: bold;', 'color: black;', value);
    };

    onAuthStateChangedHandler((user) => {
      log('로그인 상태 변경', user);
      if (user && isAuthorized(user.email)) {
        authUI.style.display = 'none';
        panel.style.display = 'block';
        loadQuizPool();
        loadSuggestions();
        log('✅ 관리자 로그인 성공', user.email);
      } else {
        authMessage.textContent = user
          ? `🚫 ${user.email}은 접근 권한이 없습니다.`
          : '🔒 로그인 필요';
        panel.style.display = 'none';
        log('⛔️ 관리자 접근 거부', user?.email || '비로그인');
      }
    });

    document.getElementById('loginBtn').addEventListener('click', () => {
      log('🔑 로그인 버튼 클릭됨', '');
      signIn((user) => {
        alert(`환영합니다, ${user.displayName}`);
        log('로그인 성공', user);
      });
    });

    document.getElementById('regQuizBtn').addEventListener('click', async () => {
      log('📩 [등록 버튼 클릭됨]', '');

      const keyword = document.getElementById('regKeyword').value.trim();
      const hint = document.getElementById('regHint').value.trim();
      const meaning = document.getElementById('regMeaning').value.trim();

      log('입력값 검사', { keyword, hint, meaning });

      if (!keyword || !hint || !meaning) {
        alert('모든 항목을 입력해주세요');
        return;
      }

      try {
        await dbPush(dbRef(db, 'quizzesPool'), { keyword, hint, meaning });
        alert('퀴즈가 등록되었습니다!');
        log('✅ 퀴즈 등록 성공', { keyword, hint });
        document.getElementById('regKeyword').value = '';
        document.getElementById('regHint').value = '';
        document.getElementById('regMeaning').value = '';
        loadQuizPool();
      } catch (error) {
        console.error('❌ [오류] 퀴즈 등록 실패:', error);
        alert('퀴즈 등록 중 오류가 발생했습니다.');
      }
    });

    async function loadQuizPool() {
      try {
        const snapshot = await dbGet(dbRef(db, 'quizzesPool'));
        const select = document.getElementById('quizPool');
        select.innerHTML = '';
        const data = snapshot.val() || {};
        Object.entries(data).forEach(([id, q]) => {
          const opt = document.createElement('option');
          opt.value = JSON.stringify(q);
          opt.textContent = `${q.keyword} / ${q.hint}`;
          select.appendChild(opt);
        });
        log('📚 퀴즈 풀 불러오기 완료', data);
      } catch (error) {
        console.error('❌ [오류] 퀴즈 풀 불러오기 실패:', error);
      }
    }

    document.getElementById('assignBtn').addEventListener('click', async () => {
      const raw = document.getElementById('quizPool').value;
      const date = document.getElementById('targetDate').value;

      if (!raw || !date) {
        alert('퀴즈와 날짜를 모두 선택해주세요.');
        return;
      }

      const quiz = JSON.parse(raw);
      log('📅 날짜 배치 시도', { date, quiz });

      try {
        await dbSet(dbRef(db, `quizzes/${date}`), quiz);
        alert(`✅ ${date}에 퀴즈가 배치되었습니다.`);
        log('✅ 날짜 배치 성공', date);
      } catch (error) {
        console.error('❌ [오류] 날짜 배치 실패:', error);
        alert('날짜 배치 중 오류가 발생했습니다.');
      }
    });

    async function loadSuggestions() {
      try {
        const ul = document.getElementById('suggestList');
        const snapshot = await dbGet(dbRef(db, 'suggestions'));
        const data = snapshot.val() || {};
        ul.innerHTML = '';
        Object.values(data).reverse().forEach(entry => {
          const li = document.createElement('li');
          li.textContent = `${entry.term} - ${entry.meaning}`;
          ul.appendChild(li);
        });
        log('📥 제보 불러오기 완료', data);
      } catch (error) {
        console.error('❌ [오류] 제보 불러오기 실패:', error);
      }
    }
  </script>
</body>
</html>
